# アメモバ Google口コミモニターサイト 仕様書 v0.1


## 1. 目的
- アメモバ各店舗のGoogle口コミを定常的にモニターし、店舗ごとの評判推移（件数・平均評価）と投稿内容を確認できるようにする。
- 週次/月次のレポート作成を効率化し、低評価・ネガ傾向を早期検知する。

## 2. 対象店舗（直営）
※将来的店舗を追加可能な設計にする

shoplist.mdを参照

Google API Key:
AIzaSyAdGICjMXFQFQjzOroPmRYtx9U0rfR8h7k
---

## 3. 用語
- 口コミ：Google上のReview（星評価 + テキスト + 投稿日時）
- 評価（rating）：1〜5の整数
- 集計粒度：日別 / 週別 / 月別
- 期間：開始日〜終了日（デフォルトは直近30日）

---

## 4. 権限・利用者
- 管理者（Admin）：店舗マスタ追加/編集、データ取得設定、ユーザー管理
- 一般閲覧（Viewer）：ダッシュボード閲覧、口コミ一覧閲覧

※認証無し（IP制限）でOK。

---

## 5. 画面一覧
1) ダッシュボード（集計）
2) 口コミ一覧（投稿内容）
3) 店舗管理（管理者のみ / 任意）
4) データ取得ステータス（管理者のみ / 任意）

---

## 6. 機能要件

### 6.1 ダッシュボード（集計）
#### 6.1.1 表示内容
- 指標A：口コミ投稿件数（期間内）
- 指標B：⭐点数の平均（期間内）
- 時系列グラフ：
  - X軸：日/週/月（切り替え）
  - Y軸：投稿件数（棒 or 折れ線）
  - 追加表示（任意）：平均⭐（折れ線）
- 店舗比較グラフ：
  - 店舗別の平均⭐推移を同一グラフで表示

#### 6.1.2 切り替え・フィルター
- 店舗フィルター
  - 単一選択（デフォルト：全店舗合算）
  - 任意：複数選択（比較用途）
- 期間フィルター
  - DateRange（開始日〜終了日）
  - クイック選択：7日 / 30日 / 90日 / 今月 / 先月
- 粒度切替
  - 日別 / 週別 / 月別

#### 6.1.3 集計仕様（定義）
- 投稿件数：期間内の `review.created_at` の件数
- 平均⭐：期間内の `review.rating` の平均（小数1桁表示、内部はfloat）
- 週別の定義：
  - 月曜開始（ISO-8601週）を基本
- 同一レビューの重複排除：
  - `source_review_id`（Google側ID）をユニークキーとして1件にする

---

### 6.2 口コミ一覧（投稿内容）
#### 6.2.1 表示内容（一覧）
- 投稿日時
- 店舗名
- ⭐評価
- 投稿者名（取得可能な範囲で）
- 投稿本文（全文 or 省略+詳細）
- 口コミURL（Googleマップの該当口コミ/店舗ページへ）
- （任意）返信（オーナー返信）が取得できるなら表示

#### 6.2.2 フィルター
- 店舗別（単一 or 複数）
- 期間（開始日〜終了日）

#### 6.2.3 並び順
- ⭐評価 高い順（5→1）
- ⭐評価 低い順（1→5）
- （任意）新しい順 / 古い順

#### 6.2.4 詳細表示（任意）
- 一覧からクリックで詳細モーダル/詳細ページ
- 本文全文、返信、投稿者情報、原文リンク

---

## 7. 非機能要件
### 7.1 性能
- ダッシュボード初期表示：3秒以内（直近30日・全店舗）
- 口コミ一覧：1ページ 50件、ページング or 無限スクロール

### 7.2 可用性
- 取得ジョブ失敗時に、前回取得データは閲覧可能にする

### 7.3 監査・ログ
- 取得ジョブの実行ログ（開始/終了/成功失敗/取得件数/エラー）を保存
- UI上で最新取得日時を表示


---

## 8. データ要件（DB設計のたたき）
### 8.1 店舗マスタ `stores`
- id（UUID）
- name（店舗名）
- type（enum: DIRECT / FRANCHISE / UNKNOWN）
- google_maps_url（検索URLでも可）
- place_id（可能なら保持）
- created_at / updated_at

### 8.2 口コミ `reviews`
- id（UUID）
- store_id（FK）
- source（enum: GOOGLE）
- source_review_id（ユニーク）
- rating（int 1-5）
- text（string / text）
- author_name（string）
- created_at（投稿日）
- fetched_at（取得日時）
- review_url（string）
- raw_payload（json / 任意）

### 8.3 集計キャッシュ（任意） `review_aggregates`
- store_id
- granularity（DAY/WEEK/MONTH）
- bucket_start_date（集計バケツ開始日）
- review_count
- rating_avg
- updated_at

※最初はSQL集計で十分。データ量が増えたらキャッシュテーブルを導入。

---

## 9. 外部連携（取得方式：方針だけ先に定義）
### 9.1 取得対象
- 各店舗のGoogle口コミ（rating / text / created_at など）

### 9.2 取得方法（候補）
- A) Google Business Profile API（推奨：正攻法だが権限が必要）
- B) Places API（レビュー取得は制限がある可能性あり）
- C) スクレイピング（非推奨：規約/仕様変更リスクが高い）

※実装前に「どのAPIで何が取れるか」を確定し、取れない項目はUI/仕様から外すか代替する。

### 9.3 取得頻度
- 毎日 1回（例：深夜） + 手動再取得ボタン（管理者のみ）
- 取得範囲：直近N日 or 差分（source_review_idで差分判定）

---

## 10. 受け入れ条件（Acceptance Criteria）
### 10.1 ダッシュボード
- 店舗・期間を変えると件数と平均⭐が正しく更新される
- 粒度（日/週/月）切替で時系列のバケツが切り替わる
- 全店舗合算時、各店舗のレビューが合算される（重複なし）

### 10.2 口コミ一覧
- 店舗別/期間フィルターが効く
- ⭐高い順/低い順で正しくソートされる
- 原文リンクからGoogle上の店舗/レビューに遷移できる

---

## 11. 今後の拡張（現段階では開発しない）
- 低評価アラート（⭐1-2が入ったらSlack/メール通知）
- ネガ/ポジ分類、頻出ワード抽出（LLM要約）
- 返信（オーナー返信）管理・テンプレート化
- 店舗管理ページ（店舗マスタに追加するだけで画面に出る）
- ユーザー認証（Googleログイン等）